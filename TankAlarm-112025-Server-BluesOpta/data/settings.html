<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Server Settings - Tank Alarm</title><style>:root{font-family:"Segoe UI",Arial,sans-serif;color-scheme:light dark}*{box-sizing:border-box}body{margin:0;min-height:100vh;background:var(--bg);color:var(--text);transition:background 0.2s ease,color 0.2s ease}body[data-theme="light"]{--bg:#f8fafc;--surface:#ffffff;--text:#1f2933;--muted:#475569;--header-bg:#e2e8f0;--card-border:rgba(15,23,42,0.08);--card-shadow:rgba(15,23,42,0.08);--accent:#2563eb;--accent-strong:#1d4ed8;--accent-contrast:#f8fafc;--chip:#f8fafc;--input-border:#cbd5e1;--danger:#ef4444;--pill-bg:rgba(37,99,235,0.12)}body[data-theme="dark"]{--bg:#0f172a;--surface:#1e293b;--text:#e2e8f0;--muted:#94a3b8;--header-bg:#16213d;--card-border:rgba(15,23,42,0.55);--card-shadow:rgba(0,0,0,0.55);--accent:#38bdf8;--accent-strong:#22d3ee;--accent-contrast:#0f172a;--chip:rgba(148,163,184,0.15);--input-border:rgba(148,163,184,0.4);--danger:#f87171;--pill-bg:rgba(56,189,248,0.18)}header{background:var(--header-bg);padding:28px 24px;box-shadow:0 20px 45px var(--card-shadow)}header .bar{display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap;align-items:flex-start}header h1{margin:0;font-size:1.9rem}header p{margin:8px 0 0;color:var(--muted);max-width:640px;line-height:1.4}.header-actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center}.pill{padding:10px 20px;text-decoration:none;font-weight:600;background:var(--pill-bg);color:var(--accent);border:1px solid transparent;transition:transform 0.15s ease}.pill:hover{transform:translateY(-1px)}.icon-button{width:42px;height:42px;border:1px solid var(--card-border);background:var(--surface);color:var(--text);font-size:1.2rem;cursor:pointer;transition:transform 0.15s ease}.icon-button:hover{transform:translateY(-1px)}main{padding:24px;max-width:1000px;margin:0 auto;width:100%}.card{background:var(--surface);border:1px solid var(--card-border);padding:20px;box-shadow:0 25px 55px var(--card-shadow)}h2{margin-top:0;font-size:1.3rem}h3{margin:20px 0 10px;font-size:1.1rem;border-bottom:1px solid var(--card-border);padding-bottom:6px;color:var(--text)}.field{display:flex;flex-direction:column;margin-bottom:12px}.field span{font-size:0.9rem;color:var(--muted);margin-bottom:4px}.field input,.field select{padding:10px 12px;border:1px solid var(--input-border);font-size:0.95rem;background:var(--bg);color:var(--text)}.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}.toggle-group{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:16px 0}.toggle{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--card-border);padding:10px 14px;background:var(--chip)}.toggle span{font-size:0.9rem;color:var(--muted)}.actions{margin-top:24px;display:flex;gap:12px;flex-wrap:wrap}button{border:none;padding:10px 16px;font-size:0.95rem;font-weight:600;cursor:pointer;background:var(--accent);color:var(--accent-contrast);transition:transform 0.15s ease}button.secondary{background:transparent;border:1px solid var(--card-border);color:var(--text)}button:hover{transform:translateY(-1px)}button:disabled{opacity:0.5;cursor:not-allowed;transform:none}#toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0284c7;color:#fff;padding:12px 18px;box-shadow:0 10px 30px rgba(15,23,42,0.25);opacity:0;pointer-events:none;transition:opacity 0.3s ease;font-weight:600}#toast.show{opacity:1}.modal{position:fixed;inset:0;background:rgba(15,23,42,0.4);display:flex;align-items:center;justify-content:center;z-index:999;backdrop-filter:blur(4px)}.modal.hidden{opacity:0;pointer-events:none}.modal-card{background:var(--surface);padding:28px 26px 24px;width:min(420px,90%);border:1px solid var(--card-border);box-shadow:0 24px 50px rgba(15,23,42,0.35)}.modal-card h2{margin-top:0}.modal-card .field + .actions{margin-top:12px}.pin-hint{display:block;margin-top:6px;color:var(--muted);font-size:0.9rem}.modal-badge{position:absolute;top:14px;right:16px;padding:6px 10px;font-size:0.75rem;background:var(--chip);color:var(--muted);border:1px solid var(--card-border)}.hidden{display:none !important}</style></head><body data-theme="light"><header><div class="bar"><div><h1>Server Settings</h1><p>Configure server-wide settings including SMS alerts, FTP backup, and daily email reports.</p><p id="fwVersion" style="margin:6px 0 0;font-size:0.85rem;color:var(--muted)">Firmware: loading...</p></div><div class="header-actions"><a class="pill secondary" href="/Tutorials/Tutorials-112025/FIRMWARE_UPDATE_GUIDE.md" target="_blank" title="Firmware Update Guide">ðŸ“š Update Guide</a><a class="pill secondary" href="/">Dashboard</a><a class="pill secondary" href="/client-console">Client Console</a><a class="pill secondary" href="/config-generator">Config Generator</a><a class="pill secondary" href="/contacts">Contacts</a><a class="pill secondary" href="/serial-monitor">Serial Monitor</a><a class="pill secondary" href="/calibration">Calibration</a><a class="pill secondary" href="/historical">Historical Data</a><a class="pill" href="/server-settings">Server Settings</a></div></div></header><main><div class="card"><h2>Server Configuration</h2><form id="settingsForm"><h3>Blues Notehub</h3><div class="form-grid"><label class="field"><span>Product UID</span><input id="productUidInput" type="text" placeholder="com.company.product:project"></label></div><p style="color:var(--muted);font-size:0.85rem;margin:-8px 0 16px;">The Product UID from your Blues Notehub project. Changing this requires a device restart to fully apply.</p><h3>Server SMS Alerts</h3><div class="form-grid"><label class="field"><span>SMS Primary</span><input id="smsPrimaryInput" type="text" placeholder="+1234567890"></label><label class="field"><span>SMS Secondary</span><input id="smsSecondaryInput" type="text" placeholder="+1234567890"></label></div><div class="toggle-group"><label class="toggle"><span>Send SMS on High Alarm</span><input type="checkbox" id="smsHighToggle"></label><label class="toggle"><span>Send SMS on Low Alarm</span><input type="checkbox" id="smsLowToggle"></label><label class="toggle"><span>Send SMS on Clear Alarm</span><input type="checkbox" id="smsClearToggle"></label></div><h3>Daily Email Report</h3><div class="form-grid"><label class="field"><span>Daily Email Hour (0-23)</span><input id="dailyHourInput" type="number" min="0" max="23" value="5"></label><label class="field"><span>Daily Email Minute (0-59)</span><input id="dailyMinuteInput" type="number" min="0" max="59" value="0"></label><label class="field"><span>Daily Report Email</span><input id="dailyEmailInput" type="email" placeholder="reports@example.com"></label></div><h3>Security</h3><div class="actions" style="margin-bottom: 24px;"><button type="button" class="secondary" id="changePinBtn">Change Admin PIN</button></div><h3>FTP Backup & Restore</h3><div class="form-grid"><label class="field"><span>FTP Host</span><input id="ftpHost" type="text" placeholder="192.168.1.50"></label><label class="field"><span>FTP Port</span><input id="ftpPort" type="number" min="1" max="65535" value="21"></label><label class="field"><span>FTP User</span><input id="ftpUser" type="text" placeholder="user"></label><label class="field"><span>FTP Password <small style="color:var(--muted);font-weight:400;">(leave blank to keep)</small></span><input id="ftpPass" type="password" autocomplete="off"></label><label class="field"><span>FTP Path</span><input id="ftpPath" type="text" placeholder="/tankalarm/server"></label></div><div class="toggle-group"><label class="toggle"><span>Enable FTP</span><input type="checkbox" id="ftpEnabled"></label><label class="toggle"><span>Passive Mode</span><input type="checkbox" id="ftpPassive" checked></label><label class="toggle"><span>Auto-backup on save</span><input type="checkbox" id="ftpBackupOnChange"></label><label class="toggle"><span>Restore on boot</span><input type="checkbox" id="ftpRestoreOnBoot"></label></div><div class="actions"><button type="button" id="ftpBackupNow">Backup Now</button><button type="button" class="secondary" id="ftpRestoreNow">Restore Now</button></div><div class="actions"><button type="submit">Save Settings</button></div></form></div></main><div id="toast"></div><div id="pinModal" class="modal hidden"><div class="modal-card"><div class="modal-badge" id="pinSessionBadge">Session</div><h2 id="pinModalTitle">Set Admin PIN</h2><p id="pinModalDescription">Enter a 4-digit PIN to unlock configuration changes.</p><form id="pinForm"><label class="field hidden" id="pinCurrentGroup"><span>Current PIN</span><input type="password" id="pinCurrentInput" inputmode="numeric" pattern="\d*" maxlength="4" autocomplete="off"></label><label class="field" id="pinPrimaryGroup"><span id="pinPrimaryLabel">PIN</span><input type="password" id="pinInput" inputmode="numeric" pattern="\d*" maxlength="4" autocomplete="off" required placeholder="4 digits" aria-describedby="pinHint" title="Enter exactly four digits (0-9)"><small class="pin-hint" id="pinHint">Use exactly 4 digits (0-9). The PIN is kept locally in this browser for 90 days.</small></label><label class="field hidden" id="pinConfirmGroup"><span>Confirm PIN</span><input type="password" id="pinConfirmInput" inputmode="numeric" pattern="\d*" maxlength="4" autocomplete="off"></label><div class="actions"><button type="submit" id="pinSubmit">Save PIN</button><button type="button" class="secondary" id="pinCancel">Cancel</button></div></form></div></div><script>const state={pin:null,pinConfigured:false,pendingAction:null};const els={productUid:document.getElementById('productUidInput'),smsPrimary:document.getElementById('smsPrimaryInput'),smsSecondary:document.getElementById('smsSecondaryInput'),smsHighToggle:document.getElementById('smsHighToggle'),smsLowToggle:document.getElementById('smsLowToggle'),smsClearToggle:document.getElementById('smsClearToggle'),dailyHour:document.getElementById('dailyHourInput'),dailyMinute:document.getElementById('dailyMinuteInput'),dailyEmail:document.getElementById('dailyEmailInput'),ftpEnabled:document.getElementById('ftpEnabled'),ftpPassive:document.getElementById('ftpPassive'),ftpBackupOnChange:document.getElementById('ftpBackupOnChange'),ftpRestoreOnBoot:document.getElementById('ftpRestoreOnBoot'),ftpHost:document.getElementById('ftpHost'),ftpPort:document.getElementById('ftpPort'),ftpUser:document.getElementById('ftpUser'),ftpPass:document.getElementById('ftpPass'),ftpPath:document.getElementById('ftpPath'),ftpBackupNow:document.getElementById('ftpBackupNow'),ftpRestoreNow:document.getElementById('ftpRestoreNow'),form:document.getElementById('settingsForm'),toast:document.getElementById('toast'),changePinBtn:document.getElementById('changePinBtn')};const pinEls={modal:document.getElementById('pinModal'),title:document.getElementById('pinModalTitle'),desc:document.getElementById('pinModalDescription'),form:document.getElementById('pinForm'),currentGroup:document.getElementById('pinCurrentGroup'),currentInput:document.getElementById('pinCurrentInput'),primaryGroup:document.getElementById('pinPrimaryGroup'),primaryLabel:document.getElementById('pinPrimaryLabel'),input:document.getElementById('pinInput'),confirmGroup:document.getElementById('pinConfirmGroup'),confirmInput:document.getElementById('pinConfirmInput'),submit:document.getElementById('pinSubmit'),cancel:document.getElementById('pinCancel'),badge:document.getElementById('pinSessionBadge')};let pinMode='unlock';function showToast(message,isError){els.toast.textContent=message;els.toast.style.background=isError?'#dc2626':'#0284c7';els.toast.classList.add('show');setTimeout(()=>els.toast.classList.remove('show'),2500);}function showPinModal(mode,callback){pinMode=mode;state.pendingAction=callback;pinEls.form.reset();pinEls.currentGroup.classList.add('hidden');pinEls.confirmGroup.classList.add('hidden');pinEls.badge.classList.add('hidden');pinEls.currentInput.required=false;pinEls.confirmInput.required=false;if(mode==='setup'){pinEls.title.textContent='Set Admin PIN';pinEls.desc.textContent='Create a 4-digit PIN to secure server settings.';pinEls.primaryLabel.textContent='New PIN';pinEls.confirmGroup.classList.remove('hidden');pinEls.confirmInput.required=true;pinEls.submit.textContent='Set PIN';}else if(mode==='change'){pinEls.title.textContent='Change Admin PIN';pinEls.desc.textContent='Enter your current PIN and a new PIN.';pinEls.currentGroup.classList.remove('hidden');pinEls.currentInput.required=true;pinEls.primaryLabel.textContent='New PIN';pinEls.confirmGroup.classList.remove('hidden');pinEls.confirmInput.required=true;pinEls.submit.textContent='Change PIN';}else{pinEls.title.textContent='Admin Access Required';pinEls.desc.textContent='Enter your 4-digit PIN to continue.';pinEls.primaryLabel.textContent='PIN';pinEls.badge.classList.remove('hidden');pinEls.submit.textContent='Unlock';}pinEls.modal.classList.remove('hidden');if(mode==='change'){pinEls.currentInput.focus();}else{pinEls.input.focus();}}function hidePinModal(){pinEls.modal.classList.add('hidden');state.pendingAction=null;}async function handlePinSubmit(e){e.preventDefault();const pin=pinEls.input.value.trim();if(pinMode==='unlock'){if(pin.length!==4){showToast('PIN must be 4 digits',true);return;}state.pin=pin;hidePinModal();if(state.pendingAction)state.pendingAction();return;}const confirm=pinEls.confirmInput.value.trim();if(pin!==confirm){showToast('PINs do not match',true);return;}const payload={newPin:pin};if(pinMode==='change'){payload.currentPin=pinEls.currentInput.value.trim();}try{const res=await fetch('/api/pin',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(!res.ok){const text=await res.text();throw new Error(text||'Failed to update PIN');}state.pin=pin;state.pinConfigured=true;showToast('PIN updated successfully');hidePinModal();updatePinButton();}catch(err){showToast(err.message,true);}}pinEls.form.addEventListener('submit',handlePinSubmit);pinEls.cancel.addEventListener('click',hidePinModal);function updatePinButton(){if(state.pinConfigured){els.changePinBtn.textContent='Change Admin PIN';}else{els.changePinBtn.textContent='Set Admin PIN';}}els.changePinBtn.addEventListener('click',()=>{if(state.pinConfigured){showPinModal('change');}else{showPinModal('setup');}});function requestPin(callback){if(state.pinConfigured&&!state.pin){showPinModal('unlock',callback);}else{callback();}}async function loadSettings(){try{const res=await fetch('/api/clients');if(!res.ok)throw new Error('Failed to fetch server data');const data=await res.json();const fwEl=document.getElementById('fwVersion');if(data&&data.fwv){fwEl.textContent='Firmware: v'+data.fwv+(data.fwb?' ('+data.fwb+')':'');}else{fwEl.textContent='Firmware: unknown';}let serverInfo={};if(data&&data.srv){const s=data.srv||{};serverInfo={productUid:s.pu||'',smsPrimary:s.sp||'',smsSecondary:s.ss||'',smsOnHigh:!!s.sh,smsOnLow:!!s.sl,smsOnClear:!!s.sc,dailyHour:typeof s.dh==='number'?s.dh:5,dailyMinute:typeof s.dm==='number'?s.dm:0,dailyEmail:s.de||''};state.pinConfigured=!!s.pc;}updatePinButton();els.productUid.value=serverInfo.productUid||'';els.smsPrimary.value=serverInfo.smsPrimary||'';els.smsSecondary.value=serverInfo.smsSecondary||'';els.smsHighToggle.checked=!!serverInfo.smsOnHigh;els.smsLowToggle.checked=!!serverInfo.smsOnLow;els.smsClearToggle.checked=!!serverInfo.smsOnClear;els.dailyHour.value=serverInfo.dailyHour||5;els.dailyMinute.value=serverInfo.dailyMinute||0;els.dailyEmail.value=serverInfo.dailyEmail||'';const ftp=serverInfo.ftp||{};els.ftpEnabled.checked=!!ftp.enabled;els.ftpPassive.checked=ftp.passive!==false;els.ftpBackupOnChange.checked=!!ftp.backupOnChange;els.ftpRestoreOnBoot.checked=!!ftp.restoreOnBoot;els.ftpHost.value=ftp.host||'';els.ftpPort.value=ftp.port||21;els.ftpUser.value=ftp.user||'';els.ftpPath.value=ftp.path||'/tankalarm/server';els.ftpPass.value='';}catch(err){showToast(err.message||'Failed to load settings',true);}}async function saveSettingsImpl(){const ftpSettings={enabled:!!els.ftpEnabled.checked,passive:!!els.ftpPassive.checked,backupOnChange:!!els.ftpBackupOnChange.checked,restoreOnBoot:!!els.ftpRestoreOnBoot.checked,host:els.ftpHost.value.trim(),port:parseInt(els.ftpPort.value,10)||21,user:els.ftpUser.value.trim(),path:els.ftpPath.value.trim()||'/tankalarm/server'};const ftpPass=els.ftpPass.value.trim();if(ftpPass){ftpSettings.pass=ftpPass;}const payload={pin:state.pin||'',server:{productUid:els.productUid.value.trim(),smsPrimary:els.smsPrimary.value.trim(),smsSecondary:els.smsSecondary.value.trim(),smsOnHigh:!!els.smsHighToggle.checked,smsOnLow:!!els.smsLowToggle.checked,smsOnClear:!!els.smsClearToggle.checked,dailyHour:parseInt(els.dailyHour.value,10)||5,dailyMinute:parseInt(els.dailyMinute.value,10)||0,dailyEmail:els.dailyEmail.value.trim(),ftp:ftpSettings}};try{const res=await fetch('/api/server-settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(!res.ok){if(res.status===403){state.pin=null;throw new Error('PIN required or invalid');}const text=await res.text();throw new Error(text||'Server rejected settings');}showToast('Settings saved successfully');await loadSettings();}catch(err){if(err.message==='PIN required or invalid'){showPinModal('unlock',saveSettingsImpl);}else{showToast(err.message||'Failed to save settings',true);}}}els.form.addEventListener('submit',(e)=>{e.preventDefault();requestPin(saveSettingsImpl);});async function performFtpAction(kind){const payload={};const endpoint=kind==='restore'?'/api/ftp-restore':'/api/ftp-backup';try{const res=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(!res.ok){const text=await res.text();throw new Error(text||`${kind} failed`);}const data=await res.json();if(data&&data.message){showToast(data.message,false);}else{showToast(kind==='restore'?'FTP restore completed':'FTP backup completed');}}catch(err){showToast(err.message||`FTP ${kind} failed`,true);}}els.ftpBackupNow.addEventListener('click',()=>performFtpAction('backup'));els.ftpRestoreNow.addEventListener('click',()=>performFtpAction('restore'));loadSettings();</script></body></html>