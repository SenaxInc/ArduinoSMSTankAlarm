<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Serial Monitor - Tank Alarm Server</title><style>:root{font-family:"Segoe UI",Arial,sans-serif;color-scheme:light dark}*{box-sizing:border-box}body{margin:0;min-height:100vh;background:var(--bg);color:var(--text);transition:background 0.2s ease,color 0.2s ease}body[data-theme="light"]{--bg:#f8fafc;--surface:#ffffff;--text:#1f2933;--muted:#475569;--header-bg:#e2e8f0;--card-border:rgba(15,23,42,0.08);--card-shadow:rgba(15,23,42,0.08);--accent:#2563eb;--accent-strong:#1d4ed8;--accent-contrast:#f8fafc;--chip:#eceff7;--pill-bg:rgba(37,99,235,0.12);--log-bg:#f1f5f9;--log-border:#cbd5e1}body[data-theme="dark"]{--bg:#0f172a;--surface:#1e293b;--text:#e2e8f0;--muted:#94a3b8;--header-bg:#16213d;--card-border:rgba(15,23,42,0.55);--card-shadow:rgba(0,0,0,0.55);--accent:#38bdf8;--accent-strong:#22d3ee;--accent-contrast:#0f172a;--chip:rgba(148,163,184,0.15);--pill-bg:rgba(56,189,248,0.18);--log-bg:#0f172a;--log-border:#334155}header{background:var(--header-bg);padding:28px 24px;box-shadow:0 20px 45px var(--card-shadow)}header .bar{display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap;align-items:flex-start}header h1{margin:0;font-size:1.9rem}header p{margin:8px 0 0;color:var(--muted);max-width:640px;line-height:1.4}.header-actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center}.pill{padding:10px 20px;text-decoration:none;font-weight:600;background:var(--pill-bg);color:var(--accent);border:1px solid transparent;transition:transform 0.15s ease}.pill:hover{transform:translateY(-1px)}.icon-button{width:42px;height:42px;border:1px solid var(--card-border);background:var(--surface);color:var(--text);font-size:1.2rem;cursor:pointer;transition:transform 0.15s ease}.icon-button:hover{transform:translateY(-1px)}main{padding:24px;max-width:1400px;margin:0 auto;width:100%}.card{background:var(--surface);border:1px solid var(--card-border);padding:20px;box-shadow:0 25px 55px var(--card-shadow);margin-bottom:20px}h2{margin-top:0;font-size:1.3rem}.controls{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center}.controls-grid{display:flex;flex-wrap:wrap;gap:16px;align-items:flex-end;margin-bottom:12px}.control-group{display:flex;flex-direction:column;gap:6px;min-width:200px;color:var(--muted);font-size:0.85rem}.control-group select,.control-group button{width:100%}.control-group.compact{flex-direction:row;align-items:stretch;gap:10px}select,button{padding:10px 16px;font-size:0.95rem;border:1px solid var(--card-border);background:var(--surface);color:var(--text);cursor:pointer}button{background:var(--accent);color:var(--accent-contrast);border-color:var(--accent);font-weight:600}button:disabled{opacity:0.5;cursor:not-allowed}button.secondary{background:transparent;color:var(--text);border-color:var(--card-border)}button.ghost{background:transparent;border:1px solid transparent;color:var(--muted);padding:4px 8px;font-size:1.1rem;min-width:32px}.log-container{background:var(--log-bg);border:1px solid var(--log-border);padding:16px;font-family:"Courier New",monospace;font-size:0.85rem;line-height:1.6;max-height:600px;overflow-y:auto;white-space:pre-wrap;word-break:break-word}.log-container.slim{max-height:360px}.log-entry{margin-bottom:8px;padding:4px 0;border-bottom:1px solid var(--card-border)}.log-entry:last-child{border-bottom:none}.log-time{color:var(--muted);font-size:0.8rem;margin-right:8px}.log-meta{display:inline-block;font-size:0.75rem;color:var(--muted);margin-right:8px}.log-message{color:var(--text)}.empty-state{text-align:center;color:var(--muted);padding:40px}.panel-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px}.client-panel{border:1px solid var(--card-border);padding:16px;background:var(--surface);box-shadow:0 15px 40px var(--card-shadow);display:flex;flex-direction:column;gap:12px}.panel-head{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}.panel-title{font-size:1rem;font-weight:600}.panel-subtitle{color:var(--muted);font-size:0.9rem}.panel-meta{font-size:0.75rem;color:var(--muted)}.panel-actions{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}.chip-row{display:flex;flex-wrap:wrap;gap:8px}.chip{background:var(--chip);color:var(--muted);padding:4px 12px;font-size:0.75rem;font-weight:600}#toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0284c7;color:#fff;padding:12px 18px;box-shadow:0 10px 30px rgba(15,23,42,0.25);opacity:0;pointer-events:none;transition:opacity 0.3s ease;font-weight:600}#toast.show{opacity:1}</style></head><body data-theme="light"><header><div class="bar"><div><h1>Serial Monitor</h1><p> View serial debug output from the server and remote client devices. Server logs update automatically, client logs can be pinned side-by-side for easier comparisons. </p></div><div class="header-actions"><a class="pill secondary" href="/">Dashboard</a><a class="pill secondary" href="/client-console">Client Console</a><a class="pill secondary" href="/config-generator">Config Generator</a><a class="pill secondary" href="/contacts">Contacts</a><a class="pill" href="/serial-monitor">Serial Monitor</a><a class="pill secondary" href="/calibration">Calibration</a><a class="pill secondary" href="/historical">Historical Data</a><a class="pill secondary" href="/server-settings">Server Settings</a></div></div></header><main><div class="card"><h2>Server Serial Output</h2><div class="controls"><button id="refreshServerBtn">Refresh Server Logs</button><button class="secondary" id="clearServerBtn">Clear Display</button><span style="color: var(--muted); font-size: 0.9rem;">Auto-refreshes every 5 seconds</span></div><div class="log-container" id="serverLogs"><div class="empty-state">Loading server logs...</div></div></div><div class="card"><h2>Client Serial Output</h2><div class="controls-grid"><label class="control-group"><span>Site Filter</span><select id="siteSelect"><option value="all">All sites</option></select></label><label class="control-group"><span>Client</span><select id="clientSelect"><option value="">-- Select a client --</option></select></label><div class="control-group compact" style="flex: 1 1 340px;"><button id="pinClientBtn" disabled>Add Client Panel</button><button id="pinSiteBtn" class="secondary" disabled>Add Site Clients</button><button id="refreshAllBtn" class="secondary">Refresh All</button><button id="clearClientBtn" class="secondary">Clear Panels</button></div></div><div class="panel-grid" id="clientPanels"><div class="empty-state">Pin one or more clients to view their serial output alongside the server.</div></div></div></main><div id="toast"></div><script>(()=>{function escapeHtml(str){if(!str)return'';const div=document.createElement('div');div.textContent=str;return div.innerHTML;}const state ={siteFilter:'all',clients:[],clientsByUid:new Map(),clientsBySite:new Map()};const clientPanels = new Map();const els ={serverLogs:document.getElementById('serverLogs'),refreshServerBtn:document.getElementById('refreshServerBtn'),clearServerBtn:document.getElementById('clearServerBtn'),siteSelect:document.getElementById('siteSelect'),clientSelect:document.getElementById('clientSelect'),pinClientBtn:document.getElementById('pinClientBtn'),pinSiteBtn:document.getElementById('pinSiteBtn'),refreshAllBtn:document.getElementById('refreshAllBtn'),clearClientBtn:document.getElementById('clearClientBtn'),clientPanels:document.getElementById('clientPanels'),toast:document.getElementById('toast')};let serverRefreshTimer = null;function showToast(message,isError){els.toast.textContent = message;els.toast.style.background = isError ? '#dc2626':'#0284c7';els.toast.classList.add('show');setTimeout(()=> els.toast.classList.remove('show'),2500);}function formatTime(epoch){if(!epoch)return '--';const date = new Date(epoch * 1000);return date.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit',second:'2-digit'});}function formatRelative(epoch){if(!epoch)return '';const diff = Math.max(0,(Date.now()/ 1000)- epoch);if(diff < 60)return `${Math.floor(diff)}s ago`;if(diff < 3600)return `${Math.floor(diff / 60)}m ago`;if(diff < 86400)return `${Math.floor(diff / 3600)}h ago`;return `${Math.floor(diff / 86400)}d ago`;}function renderLogs(container,logs){if(!logs || logs.length === 0){container.innerHTML = '<div class="empty-state">No logs available</div>';return;}container.innerHTML = '';logs.forEach(entry =>{const div = document.createElement('div');div.className = 'log-entry';const time = document.createElement('span');time.className = 'log-time';time.textContent = formatTime(entry.timestamp);const meta = document.createElement('span');meta.className = 'log-meta';const level =(entry.level || 'info').toUpperCase();const source = entry.source ? ` · ${entry.source}`:'';meta.textContent = `[${level}${source}]`;const msg = document.createElement('span');msg.className = 'log-message';msg.textContent = entry.message;div.appendChild(time);div.appendChild(meta);div.appendChild(msg);container.appendChild(div);});container.scrollTop = container.scrollHeight;}async function refreshServerLogs(){try{const res = await fetch('/api/serial-logs?source=server');if(!res.ok)throw new Error('Failed to fetch server logs');const data = await res.json();renderLogs(els.serverLogs,data.logs || []);}catch(err){console.error('Server logs error:',err);}}function ensureClientPanelPlaceholder(){if(clientPanels.size === 0){els.clientPanels.innerHTML = '<div class="empty-state">Pin one or more clients to view their serial output alongside the server.</div>';}}function clearClientPanelPlaceholder(){if(clientPanels.size === 0){els.clientPanels.innerHTML = '';}}function setClients(list){state.clients = list;state.clientsByUid = new Map(list.map(c => [c.uid,c]));state.clientsBySite = new Map();list.forEach(c =>{const site = c.site || 'Unassigned';if(!state.clientsBySite.has(site)){state.clientsBySite.set(site,[]);}state.clientsBySite.get(site).push(c);});}function renderSiteOptions(){const current = state.siteFilter;const sites = Array.from(state.clientsBySite.keys()).sort((a,b)=> a.localeCompare(b));els.siteSelect.innerHTML = '';const allOption = document.createElement('option');allOption.value = 'all';allOption.textContent = 'All sites';els.siteSelect.appendChild(allOption);sites.forEach(site =>{const opt = document.createElement('option');opt.value = site;opt.textContent = site;els.siteSelect.appendChild(opt);});if(current !== 'all' && sites.includes(current)){els.siteSelect.value = current;}else{state.siteFilter = 'all';els.siteSelect.value = 'all';}updateSiteButtons();}function renderClientOptions(){const previous = els.clientSelect.value;const candidates = state.siteFilter === 'all' ? state.clients:(state.clientsBySite.get(state.siteFilter)|| []);els.clientSelect.innerHTML = '';const placeholder = document.createElement('option');placeholder.value = '';placeholder.textContent = '-- Select a client --';els.clientSelect.appendChild(placeholder);candidates.forEach(c =>{const opt = document.createElement('option');opt.value = c.uid;const label = c.label ? `${c.label}(${c.uid})`:c.uid;opt.textContent = `${c.site || 'Unassigned'}· ${label}`;els.clientSelect.appendChild(opt);});if(previous && candidates.some(c => c.uid === previous)){els.clientSelect.value = previous;els.pinClientBtn.disabled = false;}else{els.clientSelect.value = '';els.pinClientBtn.disabled = true;}}function getClientInfo(uid){return state.clientsByUid.get(uid);}function updatePanelHeader(uid){const info = getClientInfo(uid);const panelState = clientPanels.get(uid);if(!info || !panelState){return;}panelState.title.textContent = info.site || 'Unknown Site';panelState.subtitle.textContent = info.label || uid;panelState.meta.textContent = info.uid || uid;}function updateSiteButtons(){if(state.siteFilter === 'all'){els.pinSiteBtn.disabled = true;return;}const count = state.clientsBySite.get(state.siteFilter)?.length || 0;els.pinSiteBtn.disabled = count === 0;}function pinClient(uid){if(!uid){showToast('Select a client first',true);return;}if(clientPanels.has(uid)){showToast('Client already pinned');refreshClientLogs(uid);return;}createClientPanel(uid);}async function pinSiteClients(){if(state.siteFilter === 'all'){showToast('Select a specific site first',true);return;}const clients = state.clientsBySite.get(state.siteFilter)|| [];if(!clients.length){showToast('No clients found for that site',true);return;}els.pinSiteBtn.disabled = true;for(const c of clients){if(!clientPanels.has(c.uid)){createClientPanel(c.uid);await new Promise(r => setTimeout(r,500));}}els.pinSiteBtn.disabled = false;}async function refreshAllClients(){const uids = Array.from(clientPanels.keys());if(uids.length === 0)return;els.refreshAllBtn.disabled = true;for(const uid of uids){await refreshClientLogs(uid);await new Promise(r => setTimeout(r,200));}els.refreshAllBtn.disabled = false;}function clearClientPanels(){clientPanels.forEach(panel => panel.root.remove());clientPanels.clear();ensureClientPanelPlaceholder();}function createClientPanel(uid){const info = getClientInfo(uid);if(!info){showToast('Client metadata not available yet',true);return;}if(clientPanels.size === 0){clearClientPanelPlaceholder();}const panel = document.createElement('div');panel.className = 'client-panel';panel.dataset.client = uid;panel.innerHTML = ` <div class="panel-head"><div><div class="panel-title">${escapeHtml(info.site || 'Unknown Site')}</div><div class="panel-subtitle">${escapeHtml(info.label || uid)}</div><div class="panel-meta">${escapeHtml(uid)}</div></div><div class="panel-actions"><button class="secondary" data-action="refresh">Refresh</button><button data-action="request">Request Logs</button><button class="ghost" data-action="close" title="Remove panel">&times;</button></div></div><div class="chip-row"><span class="chip" data-role="lastLog">Last log:--</span><span class="chip" data-role="lastAck">Ack:--</span><span class="chip" data-role="status">Status:idle</span></div><div class="log-container slim"><div class="empty-state">No logs yet</div></div> `;els.clientPanels.appendChild(panel);const panelState ={root:panel,logs:panel.querySelector('.log-container'),title:panel.querySelector('.panel-title'),subtitle:panel.querySelector('.panel-subtitle'),meta:panel.querySelector('.panel-meta'),requestBtn:panel.querySelector('[data-action="request"]'),refreshBtn:panel.querySelector('[data-action="refresh"]'),chips:{lastLog:panel.querySelector('[data-role="lastLog"]'),lastAck:panel.querySelector('[data-role="lastAck"]'),status:panel.querySelector('[data-role="status"]')}};panelState.refreshBtn.addEventListener('click',()=> refreshClientLogs(uid));panelState.requestBtn.addEventListener('click',()=> requestClientLogs(uid,panelState));panel.querySelector('[data-action="close"]').addEventListener('click',()=> removeClientPanel(uid));clientPanels.set(uid,panelState);refreshClientLogs(uid);}function removeClientPanel(uid){const panelState = clientPanels.get(uid);if(!panelState){return;}panelState.root.remove();clientPanels.delete(uid);ensureClientPanelPlaceholder();}function updatePanelMeta(panelState,meta ={}){const lastLog = meta.lastLogEpoch || meta.lastLog;const lastAck = meta.lastAckEpoch;const ackStatus = meta.lastAckStatus || 'n/a';panelState.chips.lastLog.textContent = lastLog ? `Last log:${formatTime(lastLog)}(${formatRelative(lastLog)})`:'Last log:--';panelState.chips.lastAck.textContent = lastAck ? `Ack:${formatTime(lastAck)}(${ackStatus})`:'Ack:--';panelState.chips.status.textContent = meta.awaitingLogs ? 'Status:awaiting client response':'Status:ready';}async function refreshClientLogs(clientUid){const panelState = clientPanels.get(clientUid);if(!panelState){return;}panelState.refreshBtn.disabled = true;panelState.chips.status.textContent = 'Status:refreshing…';try{const res = await fetch(`/api/serial-logs?source=client&client=${encodeURIComponent(clientUid)}`);if(!res.ok)throw new Error('Failed to fetch client logs');const data = await res.json();renderLogs(panelState.logs,data.logs || []);updatePanelMeta(panelState,data.meta ||{});}catch(err){console.error('Client logs error:',err);panelState.logs.innerHTML = '<div class="empty-state">Error loading client logs</div>';panelState.chips.status.textContent = 'Status:error fetching logs';}finally{panelState.refreshBtn.disabled = false;}}async function requestClientLogs(clientUid,panelState){if(!clientUid){showToast('Select a client first',true);return;}if(panelState){panelState.requestBtn.disabled = true;panelState.chips.status.textContent = 'Status:requesting logs…';}try{const res = await fetch('/api/serial-request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({client:clientUid})});if(!res.ok){const text = await res.text();throw new Error(text || 'Request failed');}showToast(`Log request sent to ${clientUid}`);if(panelState){panelState.chips.status.textContent = 'Status:awaiting client response';setTimeout(()=> refreshClientLogs(clientUid),3500);}}catch(err){console.error('Client request error:',err);showToast(err.message || 'Request failed',true);if(panelState){panelState.chips.status.textContent = 'Status:request failed';}}finally{if(panelState){setTimeout(()=>{panelState.requestBtn.disabled = false;},4000);}}}async function loadClients(){try{const res = await fetch('/api/clients');if(!res.ok)throw new Error('Failed to fetch clients');const data = await res.json();const rawClients = data.clients || [];const unique = new Map();rawClients.forEach(c =>{if(c.client){unique.set(c.client,{uid:c.client,site:c.site || 'Unassigned',label:c.label || c.client});}});setClients(Array.from(unique.values()));renderSiteOptions();renderClientOptions();clientPanels.forEach((_,uid)=> updatePanelHeader(uid));}catch(err){console.error('Failed to load clients:',err);}}els.refreshServerBtn.addEventListener('click',refreshServerLogs);els.clearServerBtn.addEventListener('click',()=>{els.serverLogs.innerHTML = '<div class="empty-state">Logs cleared</div>';});els.siteSelect.addEventListener('change',()=>{state.siteFilter = els.siteSelect.value;renderClientOptions();updateSiteButtons();});els.clientSelect.addEventListener('change',()=>{els.pinClientBtn.disabled = !els.clientSelect.value;});els.pinClientBtn.addEventListener('click',()=> pinClient(els.clientSelect.value));els.pinSiteBtn.addEventListener('click',pinSiteClients);els.refreshAllBtn.addEventListener('click',refreshAllClients);els.clearClientBtn.addEventListener('click',clearClientPanels);serverRefreshTimer = setInterval(refreshServerLogs,5000);refreshServerLogs();ensureClientPanelPlaceholder();loadClients();})();</script></body></html>