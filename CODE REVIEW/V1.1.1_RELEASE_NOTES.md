# Release Notes ‚Äî v1.1.1

**Date:** February 20, 2026
**Components:** Client, Server, and Viewer Firmware (`TankAlarm-112025-*-BluesOpta`)
**Status:** Stable Release
**Previous Release:** v1.1.0

---

## Summary

v1.1.1 introduces a **three-fleet architecture** (clients / server / viewer), a new **relay-forwarding protocol** for client-to-client relay commands via the server, **config and serial ACK improvements**, and significant code cleanup removing ~300 lines of dead code from the shared library. ArduinoJson usage in the Server and Viewer has been fully migrated to the v7 auto-sizing API.

---

## üöÄ New Features

### Viewer Fleet Support
- Viewer devices now join a dedicated **`tankalarm-viewer`** fleet during `hub.set`, enabling fleet-scoped DFU, route filtering, and device management.
- Client `createDefaultConfig()` explicitly sets `clientFleet` to `"tankalarm-clients"`.
- Documentation and Notehub route guides updated for the three-fleet model (clients / server / viewer).

### Relay Forwarding (Client ‚Üí Server ‚Üí Client)
- New relay-forwarding protocol using dedicated `relay_forward.qo` / `relay_forward.qi` notefiles (constants added in `TankAlarm_Common.h`).
- **Client:** `triggerRemoteRelays()` sends via `RELAY_FORWARD_OUTBOX_FILE` with renamed payload fields (`target`/`client` instead of `_target`/`_type`).
- **Server:** New `handleRelayForward()` function receives relay-forward notes, parses `target`/`client`/`relay`/`state`/`source`, and re-issues the command to the target client via `sendRelayCommand()`.

### Serial ACK Protocol (Client)
- New `sendSerialAck(status)` function sends `serial_ack.qo` notes with the client UID and a status string.
- `pollForSerialRequests()` now emits `"processing"` and `"complete"` ACKs around `sendSerialLogs()`.
- New `SERIAL_ACK_OUTBOX_FILE` constant in `TankAlarm_Common.h`.

### Config ACK Enhancements
- `sendConfigAck()` now accepts a third `configVersion` parameter and includes a `status` string (`"applied"` / `"failed"`) and optional `cv` (config version hash) in the ACK payload.
- Server injects `_cv` into dispatched configs from `ClientConfigSnapshot::configVersion`.
- Server keeps `pendingDispatch = true` until the ACK is received (previously cleared immediately on send).

---

## üîß Improvements

### ArduinoJson v7 Migration (Server & Viewer)
- All `DynamicJsonDocument` / `StaticJsonDocument` instances replaced with auto-sizing `JsonDocument` (ArduinoJson v7).
- Removed capacity constants: `CLIENT_JSON_CAPACITY`, `HISTORY_JSON_CAPACITY`, `COMPARE_JSON_CAPACITY`, `YOY_JSON_CAPACITY`, `CALIBRATION_JSON_CAPACITY`, `TANK_JSON_CAPACITY`.
- Updated API calls: `createNestedArray()` ‚Üí `.to<JsonArray>()`, `createNestedObject()` ‚Üí `.add<JsonObject>()`.
- Overflow error messages updated to remove references to removed capacity constants.

### Notecard UUID Handling Hardened (All Three Sketches)
- `card.uuid` request now guarded with `if (req)` null check before calling `requestAndResponse()`.
- Response properly freed via `notecard.deleteResponse(rsp)` in the correct scope.

### Serial Log Pagination Fix (Client)
- `sendSerialLogs()` now correctly sends the **20 most recent** entries by computing a `startOffset` instead of always iterating from index 0.

### Shared Utility Consolidation
- Server's local `computeNextAlignedEpoch()` replaced by shared `tankalarm_computeNextAlignedEpoch()` from `TankAlarm_Utils.h`.
- `DFU_CHECK_INTERVAL_MS` consolidated into `TankAlarm_Common.h` (was duplicated in both client and server `.ino` files).

---

## üêõ Bug Fixes

### Memory Safety
- **Server:** `sendDailyEmail()` and `publishViewerSummary()` now use `JDelete(req)` instead of `notecard.deleteResponse(req)` for freeing unsent request objects.
- **Client:** `triggerRemoteRelays()` adds `JDelete(req)` when body allocation fails, preventing a memory leak.

### Watchdog Macro Rename
- All `#ifdef WATCHDOG_AVAILABLE` corrected to `#ifdef TANKALARM_WATCHDOG_AVAILABLE` across client (6 instances) and server (8 instances), matching the macro defined in `TankAlarm_Platform.h`.

### DFU Auto-Apply Preprocessor Fix (Viewer)
- Changed `#if DFU_AUTO_ENABLE` to `#ifdef DFU_AUTO_ENABLE` (correct preprocessor guard for a potentially-undefined macro).

### Temperature Averaging Simplified (Server)
- `nwsFetchAverageTemperature()` simplified ‚Äî removed unused time-window logic; now averages the first `NWS_AVG_HOURS` values directly.

---

## üóëÔ∏è Dead Code Removal (~300 lines)

### TankAlarm_Battery.h
- Removed `getBatteryVoltageMode()`, `estimateLeadAcidSOC()`, `estimateLiFePO4SOC()`.

### TankAlarm_Notecard.h
- Removed `tankalarm_setNotecardI2CSpeed()`, `tankalarm_getNotecardUUID()`, `tankalarm_configureHub()`, `tankalarm_getNotecardStatus()` (~118 lines). Only `tankalarm_currentEpoch()` remains.

### TankAlarm_Utils.h
- Removed `tankalarm_isValidEpoch()`, `tankalarm_streq()`, `tankalarm_isEmptyString()` (~35 lines). Only `tankalarm_roundTo()` and `tankalarm_computeNextAlignedEpoch()` remain.

### TankAlarm_Config.h
- Removed `DEFAULT_SERVER_FLEET`, `DEFAULT_SOLAR_POWERED`, `DEFAULT_MPPT_ENABLED`, `GRID_INBOUND_INTERVAL_MINUTES`.

### TankAlarm_Common.h
- Removed `CONFIG_OUTBOX_FILE`, `TIME_SYNC_INTERVAL_MS`.

### Client .ino
- Removed local POSIX wrappers (`posix_file_size()`, `posix_file_exists()`, `posix_log_error()`).

### Server .ino
- Removed `convertMaToLevel()` wrapper (callers now use `convertMaToLevelWithTemp()` directly).

---

## ‚ö†Ô∏è Breaking Changes

| Change | Impact |
|--------|--------|
| Relay commands now use `relay_forward.qo` / `.qi` notefiles | **Notehub routes must be updated** to forward `relay_forward.qo` to the server. |
| Config ACK payload: `success` (bool) ‚Üí `status` (string) + `cv` field | Server `handleConfigAck` must parse the new format. |
| `sendConfigAck()` requires 3 parameters (was 2) | Any custom callers must be updated. |
| Viewer must belong to `"tankalarm-viewer"` fleet | **New fleet required in Notehub** before deploying. |
| `pendingDispatch` no longer cleared on send | Config retries now persist until ACK, changing retry behavior. |
| Watchdog macro renamed to `TANKALARM_WATCHDOG_AVAILABLE` | Custom platform headers must use the new name. |

---

## üìñ Documentation Updates

### Tutorial Accuracy Fixes
All 14 tutorial guides under `Tutorials/Tutorials-112025/` were audited against the current codebase and corrected:

| Tutorial | Fixes Applied |
|----------|---------------|
| QUICK_START_GUIDE | `server_config.h` ‚Üí `ServerConfig.h`; `PRODUCT_UID`/`SERVER_PRODUCT_UID` ‚Üí `DEFAULT_PRODUCT_UID`/`DEFAULT_SERVER_PRODUCT_UID`; removed nonexistent `config_template.h` and `SERVER_FLEET` define; corrected file tree; removed stale `SERVER_FLEET` troubleshooting check |
| SERVER_INSTALLATION_GUIDE | Rewrote Product UID section with `ServerConfig.h` + `__has_include` pattern; `WATCHDOG_TIMEOUT_SECONDS 600` ‚Üí `30`; removed nonexistent `DEFAULT_CLIENT_FLEET` compile-time define |
| CLIENT_INSTALLATION_GUIDE | `PRODUCT_UID` ‚Üí `DEFAULT_PRODUCT_UID`; fixed 4 broken relative links (`../` ‚Üí `../../`) to Server INSTALLATION.md and FLEET_SETUP.md |
| ADVANCED_CONFIGURATION_GUIDE | Complete rewrite of watchdog section ‚Äî `Watchdog.h` ‚Üí `TankAlarm_Platform.h`; correct constants (`TANKALARM_WATCHDOG_AVAILABLE`, `WATCHDOG_TIMEOUT_SECONDS 30`); correct API (`mbedWatchdog.kick()`, `TANKALARM_WATCHDOG_KICK` macro); removed fictional `watchdog.feed()`/`watchdog.nearTimeout()` |
| FLEET_SETUP_GUIDE | Added `tankalarm-viewer` fleet to Quick Start section; `SERVER_PRODUCT_UID` ‚Üí `DEFAULT_SERVER_PRODUCT_UID` |
| Tutorials README | Added `tankalarm-viewer` to fleet checklist and file tree |
| RELAY_CONTROL_GUIDE | Added `relay_forward.qo` notefile name and cross-reference to Firmware Communication Guide |
| TROUBLESHOOTING_GUIDE | Added `tankalarm-viewer` to both fleet-verification checklists; `server_config.h` ‚Üí `ServerConfig.h` |
| BACKUP_RECOVERY_GUIDE | `server_config.h` ‚Üí `ServerConfig.h`; `SERVER_PRODUCT_UID` ‚Üí `DEFAULT_SERVER_PRODUCT_UID` |
| UNLOAD_TRACKING_GUIDE | Removed dead link to nonexistent `INTEGRATION_API_GUIDE.md` |
| SERVER_INSTALLATION_GUIDE | Fixed broken relative link (`../` ‚Üí `../../`) to HISTORICAL_DATA_ARCHITECTURE.md |
| FIRMWARE_UPDATE_GUIDE | Fixed 7 broken relative links ‚Äî `CODE%20REVIEW/` and `TankAlarm-112025-*/` paths prefixed with `../../` |
| Tutorials README | Fixed `../LICENSE` ‚Üí `../../LICENSE` |

### Version & Date Bumps
- All 14 tutorial footers updated from **v1.0 | January 7, 2026** to **v1.1 | February 20, 2026**.
- Version compatibility notes bumped to **v1.1.1** across all tutorials.

### Other Documentation
- **README.md** updated with current architecture description, v1.1.1 changelog entry, and release notes link.
- **FLEET_SETUP.md** and **SERVER_INSTALLATION_GUIDE.md** updated with viewer fleet requirements.
- **library.properties** version bumped from `1.0.2` ‚Üí `1.1.1`.
- **New code review docs:** `CODE_REVIEW_FIX_IMPLEMENTATION_02202026.md`, `CODE_REVIEW_SUMMARY_02202026.md`.

---

## üì¶ Upgrade Instructions

1. **Create the viewer fleet** in Notehub: add a `tankalarm-viewer` fleet to your project.
2. **Update Notehub routes** to handle the new `relay_forward.qo` notefile (see [NOTEHUB_ROUTES_SETUP.md](../Tutorials/Tutorials-112025/NOTEHUB_ROUTES_SETUP.md)).
3. **Flash all three firmware images** (Client, Server, Viewer) ‚Äî this release requires all devices to be updated together.
4. No config file reset is required; existing configs are backward-compatible.
5. Clear browser cache or hard-refresh (Ctrl+F5) on the Server web UI.

---

## Files Changed

```
 28 files changed, 184 insertions(+), 174 deletions(-)
```

| Component | Files | Summary |
|-----------|-------|---------|
| Client .ino | 1 | Relay forwarding, serial ACK, config ACK, watchdog macro, dead code removal |
| Server .ino | 1 | Relay forward handler, ArduinoJson v7, config ACK dispatch, watchdog macro, dead code removal |
| Viewer .ino | 1 | Fleet assignment, ArduinoJson v7, UUID hardening, DFU preprocessor fix |
| Common library | 2 | New constants, version bump, library.properties 1.0.2 ‚Üí 1.1.1 |
| Tutorials | 14 | Accuracy fixes, broken link repairs, three-fleet architecture, version & date bumps |
| Other docs | 9 | README, BOM, code reviews, security doc |
